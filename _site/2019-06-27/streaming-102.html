<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Streaming Systems - Streaming 102(1) | leeyh0216’s devlog</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Streaming Systems - Streaming 102(1)" />
<meta name="author" content="leeyh0216" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Streaming 102" />
<meta property="og:description" content="Streaming 102" />
<link rel="canonical" href="http://localhost:4000/2019-06-27/streaming-102" />
<meta property="og:url" content="http://localhost:4000/2019-06-27/streaming-102" />
<meta property="og:site_name" content="leeyh0216’s devlog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-27T22:00:00+09:00" />
<script type="application/ld+json">
{"headline":"Streaming Systems - Streaming 102(1)","dateModified":"2019-06-27T22:00:00+09:00","datePublished":"2019-06-27T22:00:00+09:00","url":"http://localhost:4000/2019-06-27/streaming-102","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019-06-27/streaming-102"},"author":{"@type":"Person","name":"leeyh0216"},"description":"Streaming 102","@type":"BlogPosting","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- CSS -->
  <link rel="stylesheet" href="/assets/main.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville:400,400i,700">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="leeyh0216's devlog" />

  <!-- Google Analytics-->
  
</head>


  <body>

    <nav class="nav">
  <div class="nav-container">
    <a href="/">
      <h2 class="nav-title">leeyh0216's devlog</h2>
    </a>
    <ul>
      <li><a href="/about">About</a></li>
      <li><a href="/">Posts</a></li>
    </ul>
  </div>
</nav>


    <main>
      <div class="post">
  <div class="post-info">
    <span>Written by</span>
    
        leeyh0216
    

    
      <br>
      <span>on&nbsp;</span><time datetime="2019-06-27 22:00:00 +0900">June 27, 2019</time>
    
  </div>

  <h1 class="post-title">Streaming Systems - Streaming 102(1)</h1>
  <div class="post-line"></div>

  <h1 id="streaming-102">Streaming 102</h1>

<p>Streaming 101에서 등장한 개념 이외에도 Trigger, Watermark, Accumulation이라는 개념이 등장한다.</p>

<p><strong>Trigger</strong></p>

<p>Window의 Output을 언제 내보낼지 결정하는 동작을 의미한다.</p>

<p>단순히 한번만 Window의 결과를 출력하지 않고 Window의 결과물이 달라짐에 따라 여러 번 결과를 출력하는 것도 가능하다. 이렇게 동일한 Window의 결과를 여러 번 출력하는 것은 Late data에 의해 변경되는 Window의 결과를 출력하는데 효과적이다.</p>

<p><strong>Watermark</strong></p>

<p>Watermark는 Event time에 따른 입력 데이터의 수신 완료를 의미한다.</p>

<p>Watermark X는 X 시간 이전에 발생한 모든 Event가 시스템에서 관측되었다는 의미이다.</p>

<p><strong>Accumulation</strong></p>

<p>Accumulation은 동일한 Window에서 관측되는 여러 결과들 사이의 관계이다. Window의 출력은 동일한 Window의 이전 결과와 독립적일 수도 있고, 누적된 값일 수도 있다.</p>

<p>예를 들어 입력 데이터가 다음과 같이 세 번에 걸쳐 들어오고(Micro batch), 이 데이터들의 합을 출력하는 어플리케이션이 있다고 가정해보자.</p>

<ol>
  <li>1, 1, 1, 1, 1</li>
  <li>1, 1, 1</li>
  <li>1, 1, 1, 1</li>
</ol>

<p>각 방식에 따라 아래와 같이 출력된다.</p>

<p><strong>이전 결과에 독립적인 경우</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Event time</th>
      <th style="text-align: center">Processing time</th>
      <th style="text-align: center">결과</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">[2019-06-27 22:00:00, 2019-06-27 22:01:00]</td>
      <td style="text-align: center">2019-06-27 22:02:01</td>
      <td style="text-align: center">5</td>
    </tr>
    <tr>
      <td style="text-align: center">[2019-06-27 22:00:00, 2019-06-27 22:01:00]</td>
      <td style="text-align: center">2019-06-27 22:03:10</td>
      <td style="text-align: center">3</td>
    </tr>
    <tr>
      <td style="text-align: center">[2019-06-27 22:00:00, 2019-06-27 22:01:00]</td>
      <td style="text-align: center">2019-06-27 22:09:15</td>
      <td style="text-align: center">4</td>
    </tr>
  </tbody>
</table>

<p><strong>이전 결과에 의존적인 경우(여기서는 누적)</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Event time</th>
      <th style="text-align: center">Processing time</th>
      <th style="text-align: center">결과</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">[2019-06-27 22:00:00, 2019-06-27 22:01:00]</td>
      <td style="text-align: center">2019-06-27 22:02:01</td>
      <td style="text-align: center">5</td>
    </tr>
    <tr>
      <td style="text-align: center">[2019-06-27 22:00:00, 2019-06-27 22:01:00]</td>
      <td style="text-align: center">2019-06-27 22:03:10</td>
      <td style="text-align: center">8</td>
    </tr>
    <tr>
      <td style="text-align: center">[2019-06-27 22:00:00, 2019-06-27 22:01:00]</td>
      <td style="text-align: center">2019-06-27 22:09:15</td>
      <td style="text-align: center">12</td>
    </tr>
  </tbody>
</table>

<h2 id="going-streaming-when-and-how">Going Streaming: When and How</h2>

<h3 id="결과는-processing-time에서-언제-집계되어-출력되는가---trigger">결과는 (Processing time에서) 언제 집계되어 출력되는가? - Trigger</h3>

<p>Window의 결과가 언제 집계되어 출력되는지는 Trigger가 결정한다. Trigger에는 크게 두 가지 방식이 존재한다.</p>

<p><strong>Repeated update trigger</strong></p>

<p>Window의 결과가 바뀔 때마다 혹은 특정 Processing time 주기마다 결과를 계산하여 출력한다.</p>

<p>Repeated update trigger의 주기는 Latency와 Cost의 밸런스를 찾아서 맞추어야 한다. 예를 들어 주기가 짧을 경우 Latency는 짧아질 수 있지만 Cost(투입되는 컴퓨팅 자원 등)가 커질 수 있다.</p>

<p><strong>Completeness triggers</strong></p>

<p>Completeness trigger의 경우 Window의 모든 입력이 들어왔다고 생각될 때 Window를 처리하여 결과를 출력하는 방식이다. 일반적으로 우리가 사용하는 배치 방식의 경우, 예를 들어 일 배치인 경우 새벽 1시 이후에는 이전 일자 데이터가 모두 적재되었다고 가정하고 작업을 수행한다.</p>

<blockquote>
  <p>스트리밍 시스템에서는 일반적으로 Repeated update trigger를 사용한다.</p>
</blockquote>

<hr />

<p>Repeated update trigger에도 결과를 출력하는 방식이 여러 가지 존재한다.</p>

<p><strong>Triggering repeatedly with every record</strong></p>

<p><img src="/assets/streaming/per_record_triggering_on_a_streaming_engine.gif" alt="Triggering repeatedly with every record" /></p>

<p>입력이 한건 들어올 때마다 해당 Window의 값을 계산하여 결과를 출력하는 방식이다. 높은 Latency를 가지긴 하지만 입력 데이터가 매우 많이 빠르게 들어올 경우 결과 데이터 또한 매우 빠르게 바뀌어 보기 힘들다는 단점이 존재한다.</p>

<p><strong>Triggering repeatedly with aligned delays</strong></p>

<p><img src="/assets/streaming/triggering_repeatedly_with_aligned_delays.gif" alt="Triggering repeatedly with aligned delays" /></p>

<p>모든 Window들을 주기적으로 동시에 업데이트하는 방식이다. 대부분의 Streaming Application은 이 방식으로 동작한다. 이 방식의 단점은 모든 Window가 동일한 시점에 연산을 시작하기 때문에 해당 시점의 Workload가 매우 높고 분산되지 않는다는 점이다.</p>

<p><strong>Triggering_repeatedly_with_unaligned_delays</strong></p>

<p><img src="/assets/streaming/triggering_repeatedly_with_unaligned_delays.gif" alt="Triggering repeatedly with unaligned delays" /></p>

<p>각 Window에서 처음으로 등장한 데이터의 Processing time부터 Trigger에 설정한 시간만큼 후의 데이터로 Window의 결과를 계산하는 방식이다.
모든 Window가 동시에 연산을 수행하지 않기 때문에 Workload가 분산된다는 장점이 존재한다. 다만 구현이 매우 어렵기 때문에 Google의 Dataflow나 Apache Beam에서 밖에 지원을 하지 않는 듯 하다.</p>

<h3 id="결과는-processing-time에서-언제-집계되어-출력되는가---watermark">결과는 (Processing time에서) 언제 집계되어 출력되는가? - Watermark</h3>

<p>Watermark는 Event time 기준에서의 입력 데이터의 수신 완료를 결정짓는다.</p>

<p>데이터들의 수신은 여러 가지 이유 떄문에 늦어질 수 있다. 정말 이상적인 시스템에서라면 2019-06-29 10:10:00(Event time)에 생성된 데이터가 동일한 시각(Procesing time)에 관측되어야겠지만, 여러가지 이유로 인해 2019-06-30 23:11:00(Processing time)에 들어올 수 있다. 이와 같이 Processing time과 Event time 간에는 아무런 관계가 없고, 결과적으로 Processing time을 이용해서는 특정 시점(Event time)까지 발생한 데이터들이 모두 들어왔는지 알 수 없다.</p>

<p>그렇기 때문에 데이터의 수신 완료를 결정하는데는 Event time을 사용한다. Watermark는 특정 Event time X + (Watermark)에 발생한 데이터가 관측되었다면, X 이전에 발생한 데이터는 모두 수신이 완료되었다고 가정하는 것이다.</p>

<hr />

<h2 id="trigger-and-watermark-in-spark-streaming">Trigger and Watermark in Spark Streaming</h2>

<p>A 게임에는 여러 구역이 존재하고, 이런 구역들에 진입/퇴장 시 아래와 같은 로그가 발생한다.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">Event type</th>
      <th style="text-align: center">Event time</th>
      <th style="text-align: center">Zone</th>
      <th style="text-align: center">Character</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">1(진입)</td>
      <td style="text-align: center">2019-06-29 00:00:00</td>
      <td style="text-align: center">A</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">2(퇴장)</td>
      <td style="text-align: center">2019-06-29 01:10:10</td>
      <td style="text-align: center">A</td>
      <td style="text-align: center">0</td>
    </tr>
  </tbody>
</table>

<p>실시간을 특정 Zone에 남아 있는 사용자 수를 보고 싶다.</p>

<p>위 로그의 경우 클라이언트 로그를 사용하기 때문에 10분 간의 지연이 발생할 수 있다. 이러한 경우 Streaming Application을 작성한다면 아래와 같다.</p>

<p><strong>ZoneInOutLog.scala</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">com</span><span class="p">.</span><span class="n">leeyh0216</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="nb">log</span>

<span class="p">/**</span>
  <span class="p">*</span> <span class="n">Zone</span> <span class="err">진입</span><span class="p">/</span><span class="err">퇴장</span> <span class="err">로그</span> <span class="err">정의</span>
  <span class="p">*</span>
  <span class="p">*</span> <span class="p">@</span><span class="n">param</span> <span class="n">eventType</span> <span class="m">1</span><span class="p">:</span> <span class="err">진입</span><span class="p">,</span> <span class="m">2</span><span class="p">:</span> <span class="err">퇴장</span>
  <span class="p">*</span> <span class="p">@</span><span class="n">param</span> <span class="n">eventTime</span> <span class="n">Event</span> <span class="n">time</span><span class="p">,</span> <span class="n">Format</span><span class="p">:</span> <span class="n">yyyy</span><span class="p">-</span><span class="n">MM</span><span class="p">-</span><span class="n">dd</span> <span class="n">HH</span><span class="p">:</span><span class="n">mm</span><span class="p">:</span><span class="n">ss</span>
  <span class="p">*</span> <span class="p">@</span><span class="n">param</span> <span class="n">zone</span>      <span class="n">Zone</span> <span class="err">이름</span>
  <span class="p">*</span> <span class="p">@</span><span class="n">param</span> <span class="n">character</span> <span class="err">캐릭터</span> <span class="n">UID</span>
  <span class="p">*/</span>
<span class="k">case</span> <span class="n">class</span> <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="n">eventType</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">eventTime</span><span class="p">:</span> <span class="k">String</span><span class="p">,</span> <span class="n">zone</span><span class="p">:</span> <span class="k">String</span><span class="p">,</span> <span class="n">character</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span>
</code></pre></div></div>

<p><strong>ConcurrentUsersInZone.scala</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">com</span><span class="p">.</span><span class="n">leeyh0216</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">application</span>

<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">concurrent</span><span class="p">.</span><span class="n">TimeUnit</span>

<span class="n">import</span> <span class="n">com</span><span class="p">.</span><span class="n">leeyh0216</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="nb">log</span><span class="p">.</span><span class="n">ZoneInOutLog</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">.{</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">SparkSession</span><span class="p">}</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">execution</span><span class="p">.</span><span class="n">streaming</span><span class="p">.</span><span class="n">MemoryStream</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">streaming</span><span class="p">.{</span><span class="n">OutputMode</span><span class="p">,</span> <span class="n">StreamingQuery</span><span class="p">,</span> <span class="n">Trigger</span><span class="p">}</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">functions</span><span class="p">.</span><span class="n">_</span>

<span class="n">class</span> <span class="n">ConcurrentUsersInZone</span><span class="p">(</span><span class="n">spark</span><span class="p">:</span> <span class="n">SparkSession</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">implicit</span> <span class="n">val</span> <span class="n">sqlContext</span> <span class="p">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">sqlContext</span>

  <span class="n">def</span> <span class="n">preProcess</span><span class="p">(</span><span class="n">streamDF</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">):</span> <span class="n">DataFrame</span> <span class="p">=</span> <span class="p">{</span>
    <span class="n">streamDF</span>
      <span class="p">//</span><span class="k">String</span> <span class="err">타입의</span> <span class="n">eventTime</span><span class="err">을</span> <span class="n">TimeStamp</span> <span class="err">타입으로</span> <span class="err">변경</span>
      <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"eventTime"</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"eventTime"</span><span class="p">),</span> <span class="s2">"yyyy-MM-dd HH:mm:ss"</span><span class="p">))</span>
      <span class="p">//</span><span class="m">1</span><span class="err">인</span> <span class="err">경우</span> <span class="err">진입이므로</span> <span class="p">+</span><span class="m">1</span><span class="p">,</span> <span class="err">이외의</span> <span class="err">경우</span> <span class="err">퇴장으로</span> <span class="err">간주하고</span> <span class="p">-</span><span class="m">1</span>
      <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"inOutDelta"</span><span class="p">,</span> <span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"eventType"</span><span class="p">)</span> <span class="p">===</span> <span class="n">lit</span><span class="p">(</span><span class="m">1</span><span class="p">),</span> <span class="n">lit</span><span class="p">(</span><span class="m">1</span><span class="p">)).</span><span class="n">otherwise</span><span class="p">(</span><span class="n">lit</span><span class="p">(-</span><span class="m">1</span><span class="p">)))</span>
  <span class="p">}</span>

  <span class="n">def</span> <span class="n">process</span><span class="p">(</span><span class="n">streamDF</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span> <span class="n">sink</span><span class="p">:</span> <span class="k">String</span> <span class="p">=</span> <span class="s2">"memory"</span><span class="p">,</span> <span class="n">outputMode</span><span class="p">:</span> <span class="n">OutputMode</span> <span class="p">=</span> <span class="n">OutputMode</span><span class="p">.</span><span class="n">Append</span><span class="p">()):</span> <span class="n">StreamingQuery</span> <span class="p">=</span> <span class="p">{</span>
    <span class="n">streamDF</span>
      <span class="p">//</span><span class="err">마지막</span> <span class="n">Microbatch</span><span class="err">의</span> <span class="k">Max</span><span class="p">(</span><span class="n">Event</span> <span class="n">Time</span><span class="p">)</span> <span class="p">-</span> <span class="m">10</span><span class="err">초</span> <span class="err">까지의</span> <span class="err">데이터를</span> <span class="n">Watermark</span>
      <span class="p">.</span><span class="n">withWatermark</span><span class="p">(</span><span class="s2">"eventTime"</span><span class="p">,</span> <span class="s2">"10 seconds"</span><span class="p">)</span>
      <span class="p">//</span><span class="m">1</span><span class="err">분</span> <span class="err">단위로</span> <span class="n">Windowing</span><span class="p">,</span> <span class="n">Zone</span><span class="err">으로도</span> <span class="n">Grouping</span>
      <span class="p">.</span><span class="n">groupBy</span><span class="p">(</span><span class="n">window</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"eventTime"</span><span class="p">),</span> <span class="s2">"1 minutes"</span><span class="p">).</span><span class="k">as</span><span class="p">(</span><span class="s2">"window"</span><span class="p">),</span> <span class="n">col</span><span class="p">(</span><span class="s2">"zone"</span><span class="p">))</span>
      <span class="p">//</span><span class="m">1</span><span class="err">분</span> <span class="err">간의</span> <span class="k">In</span><span class="p">/</span><span class="n">Out</span> <span class="n">Delta</span> <span class="err">합</span>
      <span class="p">.</span><span class="n">agg</span><span class="p">(</span><span class="k">sum</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"inOutDelta"</span><span class="p">)).</span><span class="k">as</span><span class="p">(</span><span class="s2">"inOutDelta"</span><span class="p">))</span>
      <span class="p">//</span><span class="n">Sink</span> <span class="n">Format</span><span class="err">과</span> <span class="n">Output</span> <span class="n">Mode</span> <span class="err">지정</span>
      <span class="p">.</span><span class="n">writeStream</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">sink</span><span class="p">)</span>
      <span class="p">.</span><span class="n">outputMode</span><span class="p">(</span><span class="n">outputMode</span><span class="p">)</span>
      <span class="p">.</span><span class="n">queryName</span><span class="p">(</span><span class="s2">"ConcurrentUsersInZone"</span><span class="p">)</span>
      <span class="p">.</span><span class="n">option</span><span class="p">(</span><span class="s2">"truncate"</span><span class="p">,</span> <span class="s2">"false"</span><span class="p">)</span>
      <span class="p">//</span><span class="n">Watermark</span> <span class="err">작동</span> <span class="err">이후에만</span> <span class="err">결과를</span> <span class="err">갱신한다</span><span class="p">.</span>
      <span class="p">//</span><span class="m">1</span><span class="err">초마다</span> <span class="err">반복적으로</span> <span class="n">Repeated</span> <span class="n">update</span> <span class="n">trigger</span><span class="err">가</span> <span class="err">동작하여</span> <span class="err">계산하도록</span> <span class="err">합니다</span><span class="p">.</span>
      <span class="p">.</span><span class="n">trigger</span><span class="p">(</span><span class="n">Trigger</span><span class="p">.</span><span class="n">ProcessingTime</span><span class="p">(</span><span class="m">10</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">))</span>
      <span class="p">.</span><span class="n">start</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p><strong>ConcurrentUsersInZoneTest.scala</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">com</span><span class="p">.</span><span class="n">leeyh0216</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">application</span>

<span class="n">import</span> <span class="n">com</span><span class="p">.</span><span class="n">leeyh0216</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="nb">log</span><span class="p">.</span><span class="n">ZoneInOutLog</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">functions</span><span class="p">.</span><span class="n">_</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">execution</span><span class="p">.</span><span class="n">streaming</span><span class="p">.</span><span class="n">MemoryStream</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">apache</span><span class="p">.</span><span class="n">spark</span><span class="p">.</span><span class="n">sql</span><span class="p">.</span><span class="n">streaming</span><span class="p">.</span><span class="n">OutputMode</span>
<span class="n">import</span> <span class="n">org</span><span class="p">.</span><span class="n">junit</span><span class="p">.{</span><span class="n">Assert</span><span class="p">,</span> <span class="n">Test</span><span class="p">}</span>

<span class="n">class</span> <span class="n">ConcurrentUsersInZoneTest</span> <span class="p">{</span>
  <span class="n">val</span> <span class="n">spark</span> <span class="p">=</span> <span class="n">new</span> <span class="n">sql</span><span class="p">.</span><span class="n">SparkSession</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">master</span><span class="p">(</span><span class="s2">"local"</span><span class="p">).</span><span class="n">appName</span><span class="p">(</span><span class="s2">"ConcurrentUsersInZone"</span><span class="p">).</span><span class="n">config</span><span class="p">(</span><span class="s2">"spark.driver.host"</span><span class="p">,</span> <span class="s2">"localhost"</span><span class="p">).</span><span class="n">getOrCreate</span><span class="p">()</span>

  <span class="n">import</span> <span class="n">spark</span><span class="p">.</span><span class="n">implicits</span><span class="p">.</span><span class="n">_</span>

  <span class="n">implicit</span> <span class="n">val</span> <span class="n">sqlContext</span> <span class="p">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">sqlContext</span>

  <span class="n">val</span> <span class="n">memoryStream</span> <span class="p">=</span> <span class="n">MemoryStream</span><span class="p">[</span><span class="n">ZoneInOutLog</span><span class="p">]</span>

  <span class="n">val</span> <span class="n">app</span> <span class="p">=</span> <span class="n">new</span> <span class="n">ConcurrentUsersInZone</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>

  <span class="p">@</span><span class="n">Test</span>
  <span class="n">def</span> <span class="n">testPreProcess</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">df</span> <span class="p">=</span> <span class="n">Seq</span><span class="p">(</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:00"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="s2">"2019-06-29 14:00:00"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
    <span class="p">).</span><span class="n">toDF</span><span class="p">()</span>

    <span class="n">val</span> <span class="n">answer</span> <span class="p">=</span> <span class="n">Seq</span><span class="p">(</span>
      <span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:00"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
      <span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="s2">"2019-06-29 14:00:00"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
    <span class="p">).</span><span class="n">toDF</span><span class="p">(</span><span class="s2">"eventType"</span><span class="p">,</span> <span class="s2">"eventTime"</span><span class="p">,</span> <span class="s2">"zone"</span><span class="p">,</span> <span class="s2">"character"</span><span class="p">,</span> <span class="s2">"inOutDelta"</span><span class="p">)</span>

    <span class="n">val</span> <span class="n">expected</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="n">preProcess</span><span class="p">(</span><span class="n">df</span><span class="p">).</span><span class="n">select</span><span class="p">(</span><span class="s2">"eventType"</span><span class="p">,</span> <span class="s2">"eventTime"</span><span class="p">,</span> <span class="s2">"zone"</span><span class="p">,</span> <span class="s2">"character"</span><span class="p">,</span> <span class="s2">"inOutDelta"</span><span class="p">)</span>

    <span class="n">Assert</span><span class="p">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">answer</span><span class="p">.</span><span class="n">except</span><span class="p">(</span><span class="n">expected</span><span class="p">).</span><span class="k">count</span><span class="p">())</span>
    <span class="n">Assert</span><span class="p">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">expected</span><span class="p">.</span><span class="n">except</span><span class="p">(</span><span class="n">answer</span><span class="p">).</span><span class="k">count</span><span class="p">())</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="n">Test</span>
  <span class="n">def</span> <span class="n">testProcessWithAppendMode</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{</span>
    <span class="n">val</span> <span class="n">outputStream</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">preProcess</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">.</span><span class="n">toDF</span><span class="p">()))</span>

    <span class="n">memoryStream</span><span class="p">.</span><span class="n">addData</span><span class="p">(</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:00"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:20"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:20"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:45"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">outputStream</span><span class="p">.</span><span class="n">processAllAvailable</span><span class="p">()</span>
    <span class="p">//</span><span class="err">첫번째</span> <span class="err">결과</span> <span class="n">Watermark</span> <span class="err">적용이</span> <span class="err">안되기</span> <span class="err">때문에</span> <span class="err">빈</span> <span class="err">테이블이</span> <span class="err">출력됨</span>
    <span class="n">Assert</span><span class="p">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">spark</span><span class="p">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"ConcurrentUsersInZone"</span><span class="p">).</span><span class="k">count</span><span class="p">())</span>

    <span class="n">memoryStream</span><span class="p">.</span><span class="n">addData</span><span class="p">(</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:55"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="s2">"2019-06-29 13:01:11"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">val</span> <span class="n">answer2</span> <span class="p">=</span> <span class="n">Seq</span><span class="p">(</span>
      <span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:00"</span><span class="p">,</span> <span class="s2">"2019-06-29 13:01:00"</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
    <span class="p">).</span><span class="n">toDF</span><span class="p">(</span><span class="s2">"zone"</span><span class="p">,</span> <span class="s2">"start"</span><span class="p">,</span> <span class="s2">"end"</span><span class="p">,</span> <span class="s2">"inOutDelta"</span><span class="p">)</span>
      <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"start"</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"start"</span><span class="p">),</span> <span class="s2">"yyyy-MM-dd HH:mm:ss"</span><span class="p">))</span>
      <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"end"</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"end"</span><span class="p">),</span> <span class="s2">"yyyy-MM-dd HH:mm:ss"</span><span class="p">))</span>
    <span class="n">outputStream</span><span class="p">.</span><span class="n">processAllAvailable</span><span class="p">()</span>

    <span class="n">val</span> <span class="n">expected2</span> <span class="p">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"ConcurrentUsersInZone"</span><span class="p">).</span><span class="n">select</span><span class="p">(</span><span class="s2">"zone"</span><span class="p">,</span> <span class="s2">"window.start"</span><span class="p">,</span> <span class="s2">"window.end"</span><span class="p">,</span> <span class="s2">"inOutDelta"</span><span class="p">)</span>
    <span class="p">//</span><span class="err">두번째</span> <span class="err">결과</span>
    <span class="p">//</span><span class="m">2</span><span class="err">번째</span> <span class="n">Stream</span> <span class="err">중</span> <span class="n">Event</span> <span class="n">Time</span> <span class="err">이</span> <span class="err">가장</span> <span class="err">큰</span> <span class="m">2019</span><span class="p">-</span><span class="m">06</span><span class="p">-</span><span class="m">29</span> <span class="m">13</span><span class="p">:</span><span class="m">01</span><span class="p">:</span><span class="m">11</span> <span class="err">기준으로</span> <span class="n">Watermark</span> <span class="err">생성</span><span class="p">(</span><span class="m">2019</span><span class="p">-</span><span class="m">06</span><span class="p">-</span><span class="m">29</span> <span class="m">13</span><span class="p">:</span><span class="m">01</span><span class="p">:</span><span class="m">01</span><span class="p">)</span>
    <span class="p">//</span><span class="m">2</span><span class="err">번째</span> <span class="n">Stream</span><span class="err">을</span> <span class="err">포함한</span> <span class="err">이전</span> <span class="n">Stream</span><span class="err">에서</span> <span class="n">Event</span> <span class="n">Time</span><span class="err">이</span> <span class="m">13</span><span class="p">:</span><span class="m">01</span><span class="p">:</span><span class="m">01</span><span class="err">보다</span> <span class="err">작은</span> <span class="n">Window</span><span class="err">들이</span> <span class="err">계산됨</span>
    <span class="n">Assert</span><span class="p">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">answer2</span><span class="p">.</span><span class="n">except</span><span class="p">(</span><span class="n">expected2</span><span class="p">).</span><span class="k">count</span><span class="p">())</span>
    <span class="n">outputStream</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="p">@</span><span class="n">Test</span>
  <span class="n">def</span> <span class="n">testProcessWithUpdateMode</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{</span>
    <span class="p">//</span><span class="n">Output</span> <span class="n">Mode</span><span class="err">를</span> <span class="n">Update</span><span class="err">로</span> <span class="err">적용</span>
    <span class="n">val</span> <span class="n">outputStream</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="n">process</span><span class="p">(</span><span class="n">app</span><span class="p">.</span><span class="n">preProcess</span><span class="p">(</span><span class="n">memoryStream</span><span class="p">.</span><span class="n">toDF</span><span class="p">()),</span> <span class="n">outputMode</span> <span class="p">=</span> <span class="n">OutputMode</span><span class="p">.</span><span class="n">Update</span><span class="p">())</span>

    <span class="n">memoryStream</span><span class="p">.</span><span class="n">addData</span><span class="p">(</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:00"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:20"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:20"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:45"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">outputStream</span><span class="p">.</span><span class="n">processAllAvailable</span><span class="p">()</span>
    <span class="p">//</span><span class="n">Watermark</span><span class="err">가</span> <span class="err">적용되더라도</span> <span class="n">Update</span> <span class="n">Mode</span><span class="err">이기</span> <span class="err">떄문에</span> <span class="err">연산</span> <span class="err">결과가</span> <span class="err">존재함</span>
    <span class="n">val</span> <span class="n">answer1</span> <span class="p">=</span> <span class="n">Seq</span><span class="p">(</span>
      <span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:00"</span><span class="p">,</span> <span class="s2">"2019-06-29 13:01:00"</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span>
    <span class="p">).</span><span class="n">toDF</span><span class="p">(</span><span class="s2">"zone"</span><span class="p">,</span> <span class="s2">"start"</span><span class="p">,</span> <span class="s2">"end"</span><span class="p">,</span> <span class="s2">"inOutDelta"</span><span class="p">)</span>
      <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"start"</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"start"</span><span class="p">),</span> <span class="s2">"yyyy-MM-dd HH:mm:ss"</span><span class="p">))</span>
      <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"end"</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"end"</span><span class="p">),</span> <span class="s2">"yyyy-MM-dd HH:mm:ss"</span><span class="p">))</span>
    <span class="n">val</span> <span class="n">expected1</span> <span class="p">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"ConcurrentUsersInZone"</span><span class="p">).</span><span class="n">select</span><span class="p">(</span><span class="s2">"zone"</span><span class="p">,</span> <span class="s2">"window.start"</span><span class="p">,</span> <span class="s2">"window.end"</span><span class="p">,</span> <span class="s2">"inOutDelta"</span><span class="p">)</span>
    <span class="n">Assert</span><span class="p">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">answer1</span><span class="p">.</span><span class="n">except</span><span class="p">(</span><span class="n">expected1</span><span class="p">).</span><span class="k">count</span><span class="p">())</span>

    <span class="n">memoryStream</span><span class="p">.</span><span class="n">addData</span><span class="p">(</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:55"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
      <span class="n">ZoneInOutLog</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="s2">"2019-06-29 13:01:11"</span><span class="p">,</span> <span class="s2">"A"</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">val</span> <span class="n">answer2</span> <span class="p">=</span> <span class="n">Seq</span><span class="p">(</span>
      <span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="s2">"2019-06-29 13:00:00"</span><span class="p">,</span> <span class="s2">"2019-06-29 13:01:00"</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span>
      <span class="p">(</span><span class="s2">"A"</span><span class="p">,</span> <span class="s2">"2019-06-29 13:01:00"</span><span class="p">,</span> <span class="s2">"2019-06-29 13:02:00"</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
    <span class="p">).</span><span class="n">toDF</span><span class="p">(</span><span class="s2">"zone"</span><span class="p">,</span> <span class="s2">"start"</span><span class="p">,</span> <span class="s2">"end"</span><span class="p">,</span> <span class="s2">"inOutDelta"</span><span class="p">)</span>
      <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"start"</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"start"</span><span class="p">),</span> <span class="s2">"yyyy-MM-dd HH:mm:ss"</span><span class="p">))</span>
      <span class="p">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">"end"</span><span class="p">,</span> <span class="n">to_timestamp</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">"end"</span><span class="p">),</span> <span class="s2">"yyyy-MM-dd HH:mm:ss"</span><span class="p">))</span>
    <span class="n">outputStream</span><span class="p">.</span><span class="n">processAllAvailable</span><span class="p">()</span>

    <span class="n">val</span> <span class="n">expected2</span> <span class="p">=</span> <span class="n">spark</span><span class="p">.</span><span class="n">table</span><span class="p">(</span><span class="s2">"ConcurrentUsersInZone"</span><span class="p">).</span><span class="n">select</span><span class="p">(</span><span class="s2">"zone"</span><span class="p">,</span> <span class="s2">"window.start"</span><span class="p">,</span> <span class="s2">"window.end"</span><span class="p">,</span> <span class="s2">"inOutDelta"</span><span class="p">)</span>
    <span class="n">Assert</span><span class="p">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">answer2</span><span class="p">.</span><span class="n">except</span><span class="p">(</span><span class="n">expected2</span><span class="p">).</span><span class="k">count</span><span class="p">())</span>
    <span class="n">outputStream</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>


</div>

<div class="pagination">
  
    <a href="/2019-06-29/validation-with-chain-of-responsibility" class="left arrow">&#8592;</a>
  
  
    <a href="/2019-06-22/streaming-101" class="right arrow">&#8594;</a>
  

  <a href="#" class="top">Top</a>
</div>

    </main>

    <footer>
  <span>
    &copy; <time datetime="2019-10-08 19:35:35 +0900">2019</time> leeyh0216. Made with Jekyll using the <a href="https://github.com/chesterhow/tale/">Tale</a> theme.
  </span>
</footer>

  </body>
</html>
